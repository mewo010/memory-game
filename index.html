<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Memory Game</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.container {
  background:#020617;
  padding:20px;
  border-radius:12px;
  width:95%;
  max-width:500px;
}
input,button {
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:8px;
  border:none;
}
button {
  background:#3b82f6;
  color:white;
  font-size:16px;
  cursor:pointer;
}
.grid {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin-top:15px;
}
.card {
  aspect-ratio:1;
  background:#1e293b;
  border-radius:10px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:30px;
  cursor:pointer;
}
.card.open {
  background:#22c55e;
}
.hidden { display:none; }
.chat {
  background:#020617;
  height:120px;
  overflow-y:auto;
  padding:6px;
  margin-top:10px;
  border-radius:6px;
}
</style>
</head>

<body>

<div class="container" id="login">
  <h2>üß† Memory Game</h2>
  <input id="playerName" placeholder="Your name">
  <input id="roomName" placeholder="Room name">
  <input id="roomPass" placeholder="Room password">
  <button onclick="createRoom()">Create Game</button>
  <button onclick="joinRoom()">Join Game</button>
</div>

<div class="container hidden" id="game">
  <h3 id="roomTitle"></h3>
  ‚è± Time: <span id="time">120</span>s
  <div class="grid" id="grid"></div>

  <h4>üèÜ Scores</h4>
  <div id="scores"></div>

  <div id="hostControls" class="hidden">
    <button onclick="restartGame()">üîÑ Restart</button>
    <button onclick="closeRoom()">‚ùå Close Room</button>
  </div>

  <div id="waiting" class="hidden">Waiting for host decision‚Ä¶</div>

  <div id="chatSection" class="hidden">
    <h4>üí¨ Chat</h4>
    <div class="chat" id="chat"></div>
    <input id="chatInput" placeholder="Type message..." onkeydown="sendChat(event)">
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB5DEX0fuSjTud04-mR__GDpiu1-vk9SIY",
  authDomain: "memory-game-66dad.firebaseapp.com",
  databaseURL: "https://memory-game-66dad-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "memory-game-66dad",
  storageBucket: "memory-game-66dad.firebasestorage.app",
  messagingSenderId: "94001818458",
  appId: "1:94001818458:web:95184599a49e78d286e163"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const icons = ['üçé','üçå','üçá','üçí','üçâ','ü•ù','üçç','ü••'];

let user="", roomCode="", isHost=false;
let first=null, lock=false;
let timerStarted=false;

function shuffle(a){ return a.sort(()=>Math.random()-0.5); }

function getInputs() {
  return {
    name: document.getElementById("playerName").value.trim(),
    room: document.getElementById("roomName").value.trim(),
    pass: document.getElementById("roomPass").value
  };
}

function createRoom(){
  const i = getInputs();
  if(!i.name || !i.room) return alert("Fill all");

  user = i.name;
  roomCode = i.room;
  isHost = true;

  db.ref("rooms/"+roomCode).set({
    pass: i.pass,
    host: user,
    cards: shuffle([...icons,...icons]),
    open: [],
    scores: {},
    time: 120,
    state: "playing",
    chat: []
  });

  startGame();
}

function joinRoom(){
  const i = getInputs();
  if(!i.name || !i.room) return alert("Fill all");

  user = i.name;
  roomCode = i.room;

  db.ref("rooms/"+roomCode).once("value",s=>{
    if(!s.exists()) return alert("Room not found");
    if(s.val().pass !== i.pass) return alert("Wrong password");
    startGame();
  });
}

function startGame(){
  document.getElementById("login").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");
  document.getElementById("roomTitle").innerText = "Room: " + roomCode;

  db.ref("rooms/"+roomCode).on("value",s=>{
    const d=s.val(); if(!d) return;
    render(d.cards,d.open);
    updateScores(d.scores||{});
    document.getElementById("time").innerText=d.time;

    if(d.time<=0 && d.state==="playing"){
      db.ref("rooms/"+roomCode+"/state").set("ended");
    }

    if(d.state==="ended"){
      document.getElementById("chatSection").classList.remove("hidden");
      if(isHost){
        document.getElementById("hostControls").classList.remove("hidden");
      } else {
        document.getElementById("waiting").classList.remove("hidden");
      }
    }
  });

  if(isHost && !timerStarted){
    timerStarted=true;
    setInterval(()=>{
      db.ref("rooms/"+roomCode+"/time")
        .transaction(t=>t>0?t-1:0);
    },1000);
  }
}

function render(cards,open){
  const grid=document.getElementById("grid");
  grid.innerHTML="";
  cards.forEach((icon,i)=>{
    const c=document.createElement("div");
    c.className="card";
    if(open.includes(i)) c.classList.add("open");
    c.innerText=icon;
    c.onclick=()=>flip(i,icon,open);
    grid.appendChild(c);
  });
}

function flip(i,icon,open){
  if(lock||open.includes(i)) return;

  if(!first){
    first={i,icon};
    return;
  }

  if(first.icon===icon){
    db.ref("rooms/"+roomCode+"/open").set([...open,first.i,i]);
    db.ref("rooms/"+roomCode+"/scores/"+user)
      .transaction(v=>(v||0)+1);
    first=null;
  } else {
    lock=true;
    setTimeout(()=>{ lock=false; first=null; },700);
  }
}

function updateScores(s){
  const el=document.getElementById("scores");
  el.innerHTML="";
  Object.entries(s).forEach(([u,v])=>{
    el.innerHTML+=`${u}: ${v}<br>`;
  });
}

function restartGame(){
  db.ref("rooms/"+roomCode).update({
    cards: shuffle([...icons,...icons]),
    open: [],
    scores: {},
    time: 120,
    state: "playing",
    chat: []
  });
}

function closeRoom(){
  db.ref("rooms/"+roomCode).remove();
  location.reload();
}

function sendChat(e){
  if(e.key!=="Enter") return;
  db.ref("rooms/"+roomCode+"/chat").push(user+": "+e.target.value);
  e.target.value="";
}
</script>

</body>
</html>
