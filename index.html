<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Memory Game</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}
.container {
  background: #020617;
  padding: 20px;
  border-radius: 12px;
  width: 95vw;
  max-width: 700px;
}
h1 { text-align: center; }
input, button {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 8px;
  border: none;
}
button {
  background: #3b82f6;
  color: white;
  cursor: pointer;
}
.grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-top: 12px;
}
.card {
  aspect-ratio: 1/1;
  background: #1e293b;
  border-radius: 10px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 32px;
  cursor: pointer;
}
.card.open { background: #22c55e; }
.topbar {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}
.chat {
  background: #020617;
  height: 120px;
  overflow-y: auto;
  margin-top: 10px;
  padding: 6px;
  border-radius: 6px;
  font-size: 14px;
}
.win {
  display:none;
  text-align:center;
}
</style>
</head>

<body>

<div class="container" id="login">
  <h1>ğŸ§  Memory Game</h1>
  <input id="username" placeholder="Username">
  <input id="roomCode" placeholder="Room Code">
  <input id="roomPass" placeholder="Room Password">
  <button onclick="createRoom()">Create Room</button>
  <button onclick="joinRoom()">Join Room</button>
</div>

<div class="container" id="game" style="display:none;">
  <h1 id="roomTitle"></h1>

  <div class="topbar">
    <div>â± <span id="time">120</span>s</div>
    <div>ğŸ® Turn: <span id="turn"></span></div>
    <button onclick="restartRoom()">ğŸ”„ Restart</button>
  </div>

  <div class="grid" id="grid"></div>

  <h3>ğŸ† Leaderboard</h3>
  <div id="leaderboard"></div>

  <h3>ğŸ’¬ Chat</h3>
  <div class="chat" id="chat"></div>
  <input id="chatInput" placeholder="Message..." onkeydown="sendChat(event)">
</div>

<div class="container win" id="win">
  <h1>ğŸ† Game Over</h1>
  <div id="winner"></div>
  <button onclick="restartRoom()">Play Again</button>
</div>

<audio id="flipSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_115b9bdbd3.mp3"></audio>
<audio id="matchSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_c8c8a73467.mp3"></audio>
<audio id="winSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_1d0c7f3b62.mp3"></audio>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB5DEX0fuSjTud04-mR__GDpiu1-vk9SIY",
  authDomain: "memory-game-66dad.firebaseapp.com",
  databaseURL: "https://memory-game-66dad-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "memory-game-66dad",
  storageBucket: "memory-game-66dad.firebasestorage.app",
  messagingSenderId: "94001818458",
  appId: "1:94001818458:web:95184599a49e78d286e163"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const icons = ['ğŸ','ğŸŒ','ğŸ‡','ğŸ’','ğŸ‰','ğŸ¥','ğŸ','ğŸ¥¥'];

let user="", room="", first=null, lock=false;
let matched=[], players=[], turnIndex=0;
let time=120, timer=null;

/* ROOM SETUP */
function createRoom(){
  user=username.value; room=roomCode.value;
  if(!user||!room) return alert("Fill all");
  db.ref("rooms/"+room).set({
    pass: roomPass.value,
    cards: shuffle([...icons,...icons]),
    matched: [],
    scores: {[user]:0},
    players:[user],
    turn:0,
    time:120,
    chat:[]
  });
  start();
}
function joinRoom(){
  user=username.value; room=roomCode.value;
  db.ref("rooms/"+room).once("value",s=>{
    if(!s.exists()) return alert("Room not found");
    if(s.val().pass!==roomPass.value) return alert("Wrong password");
    db.ref("rooms/"+room+"/players").transaction(p=>(p||[]).includes(user)?p:[...(p||[]),user]);
    start();
  });
}

/* START */
function start(){
  login.style.display="none"; game.style.display="block";
  db.ref("rooms/"+room).on("value",s=>{
    const d=s.val(); if(!d) return;
    matched=d.matched; players=d.players; turnIndex=d.turn;
    time=d.time;
    document.getElementById("time").innerText=time;
    document.getElementById("turn").innerText=players[turnIndex];
    render(d.cards); leaderboard(d.scores); chatBox(d.chat||[]);
    if(time<=0) endGame(d.scores);
  });
  if(!timer){
    timer=setInterval(()=>{
      db.ref("rooms/"+room+"/time").set(time-1);
    },1000);
  }
}

/* GAME */
function render(cards){
  grid.innerHTML="";
  cards.forEach((icon,i)=>{
    const c=document.createElement("div");
    c.className="card";
    if(matched.includes(i)) c.classList.add("open");
    c.innerText=icon;
    c.onclick=()=>flip(c,icon,i);
    grid.appendChild(c);
  });
}
function flip(card,icon,i){
  if(lock||matched.includes(i)||players[turnIndex]!==user)return;
  if(card.classList.contains("open"))return;
  flipSound.play(); if(navigator.vibrate) navigator.vibrate(30);
  card.classList.add("open");
  if(!first){first={card,icon,i};return;}
  if(first.icon===icon){
    matchSound.play();
    matched.push(first.i,i);
    db.ref("rooms/"+room+"/matched").set(matched);
    db.ref("rooms/"+room+"/scores/"+user).transaction(v=>(v||0)+1);
    first=null;
  }else{
    lock=true;
    setTimeout(()=>{
      card.classList.remove("open");
      first.card.classList.remove("open");
      first=null; lock=false;
      db.ref("rooms/"+room+"/turn").set((turnIndex+1)%players.length);
    },700);
  }
}

/* CHAT */
function sendChat(e){
  if(e.key!=="Enter")return;
  db.ref("rooms/"+room+"/chat").push(user+": "+chatInput.value);
  chatInput.value="";
}
function chatBox(msgs){
  chat.innerHTML="";
  msgs.forEach(m=>chat.innerHTML+=m+"<br>");
}

/* UI */
function leaderboard(s){
  leaderboard.innerHTML="";
  Object.entries(s).sort((a,b)=>b[1]-a[1])
  .forEach(([u,v])=>leaderboard.innerHTML+=`${u}: ${v}<br>`);
}
function restartRoom(){
  db.ref("rooms/"+room).update({
    cards: shuffle([...icons,...icons]),
    matched: [],
    scores: {},
    time:120,
    turn:0,
    chat:[]
  });
}
function endGame(scores){
  winSound.play();
  game.style.display="none";
  win.style.display="block";
  const w=Object.entries(scores).sort((a,b)=>b[1]-a[1])[0];
  winner.innerText=`Winner: ${w[0]} (${w[1]} points)`;
}
function shuffle(a){return a.sort(()=>Math.random()-0.5);}
</script>

</body>
</html>
