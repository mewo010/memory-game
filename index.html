<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1v1 Memory Game</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* CSS Styles */
body { margin:0; font-family:Arial, sans-serif; background:#0f172a; color:white; display:flex; justify-content:center; align-items:center; min-height:100vh; }
.container { background:#1e293b; padding:20px; border-radius:12px; width:95%; max-width:500px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
h2, h3, h4 { margin-top:0; text-align:center; }
input, button { width:100%; padding:12px; margin-top:10px; border-radius:8px; border:none; box-sizing: border-box; }
input { background: #334155; color: white; }
button { background:#3b82f6; color:white; font-size:16px; cursor:pointer; font-weight:bold; transition: background 0.2s; }
button:hover { background:#2563eb; }
button.secondary { background: #ef4444; }
button:disabled { background: #64748b; cursor: not-allowed; }

/* Lobby / Waiting Styles */
.lobby-box { text-align:center; padding: 40px 20px; animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

/* Grid Layout */
.grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:20px; }
.card {
  aspect-ratio:1; background:#334155; border-radius:10px; display:flex;
  justify-content:center; align-items:center; font-size:32px; cursor:pointer;
  transition: transform 0.1s; user-select: none;
}
.card:active { transform: scale(0.95); }
.card.open { background:#22c55e; cursor:default; }
.hidden { display:none; }

/* Chat Styling */
.chat-box { background:#0f172a; height:100px; overflow-y:auto; padding:10px; margin-top:10px; border-radius:6px; display:flex; flex-direction:column; gap:5px; }
.chat-msg { font-size: 14px; border-bottom: 1px solid #334155; padding-bottom: 2px; }
.score-board { background: #0f172a; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-around; }
</style>
</head>

<body>

<div class="container" id="login">
  <h2>‚öîÔ∏è 1v1 Memory Game</h2>
  <input id="playerName" placeholder="Your Name">
  <input id="roomName" placeholder="Room Name">
  <input id="roomPass" placeholder="Room Password" type="password">
  <button onclick="createRoom()">Create New Room</button>
  <button onclick="joinRoom()" style="background:#8b5cf6">Join Room</button>
</div>

<div class="container hidden" id="game">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h3 style="margin:0" id="roomTitle"></h3>
    <button onclick="copyCode()" style="width:auto; padding:5px 10px; margin:0; font-size:12px;">Copy Room Name</button>
  </div>

  <div id="lobby" class="hidden lobby-box">
    <h3>‚è≥ Waiting for Opponent...</h3>
    <p>Share the Room Name/Password with a friend.</p>
    <p>Game will start automatically when Player 2 joins.</p>
  </div>

  <div id="gameArea" class="hidden">
    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
      <span>‚è± Time: <span id="time">120</span>s</span>
      <span id="statusText" style="color:#22c55e">Playing</span>
    </div>

    <div class="score-board" id="scores"></div>
    <div class="grid" id="grid"></div>
  </div>

  <div id="hostControls" class="hidden" style="margin-top:20px; border-top:1px solid #334155; padding-top:10px;">
    <button onclick="restartGame()">üîÑ Restart Game</button>
    <button onclick="closeRoom()" class="secondary">‚ùå Close Room</button>
  </div>
  
  <div id="gameOverMsg" class="hidden" style="text-align:center; margin-top:15px; color:#ef4444; font-weight:bold;">
    GAME OVER
  </div>

  <div id="chatSection">
    <h4>üí¨ Chat</h4>
    <div class="chat-box" id="chat"></div>
    <input id="chatInput" placeholder="Type message..." onkeydown="sendChat(event)">
  </div>
</div>

<script>
// --- CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyB5DEX0fuSjTud04-mR__GDpiu1-vk9SIY",
  authDomain: "memory-game-66dad.firebaseapp.com",
  databaseURL: "https://memory-game-66dad-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "memory-game-66dad",
  storageBucket: "memory-game-66dad.firebasestorage.app",
  messagingSenderId: "94001818458",
  appId: "1:94001818458:web:95184599a49e78d286e163"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const icons = ['üçé','üçå','üçá','üçí','üçâ','ü•ù','üçç','ü••'];
let user = "", roomCode = "", isHost = false;
let firstCard = null;
let isLocked = false;
let dbData = null;

// --- HELPERS ---
function shuffle(array) { return array.sort(() => Math.random() - 0.5); }
function getEl(id) { return document.getElementById(id); }
function getInputs() {
  return {
    name: getEl("playerName").value.trim(),
    room: getEl("roomName").value.trim(),
    pass: getEl("roomPass").value.trim()
  };
}

// --- ROOM LOGIC ---
function createRoom(){
  const i = getInputs();
  if(!i.name || !i.room) return alert("Fill in all fields");

  user = i.name;
  roomCode = i.room;
  isHost = true;

  // Set initial state to "waiting" instead of playing
  db.ref("rooms/"+roomCode).set({
    pass: i.pass,
    host: user,
    cards: shuffle([...icons, ...icons]),
    open: [],
    scores: { [user]: 0 },
    time: 120,
    state: "waiting", // CHANGED: Starts in waiting mode
    chat: {}
  });

  enterGameScreen();
}

function joinRoom(){
  const i = getInputs();
  if(!i.name || !i.room) return alert("Fill in all fields");

  user = i.name;
  roomCode = i.room;

  db.ref("rooms/"+roomCode).once("value", s => {
    if(!s.exists()) return alert("Room not found");
    const val = s.val();
    
    // VALIDATION 1: Password
    if(val.pass !== i.pass) return alert("Wrong password");
    
    // VALIDATION 2: Max Players (Check if scores object has 2 or more keys)
    const currentPlayers = Object.keys(val.scores || {}).length;
    if(currentPlayers >= 2 && !val.scores[user]) {
        return alert("Room is full (Max 2 players)!");
    }
    
    // Add user to scores if new
    if(!val.scores || !val.scores[user]) {
       db.ref("rooms/"+roomCode+"/scores/"+user).set(0);
    }
    
    enterGameScreen();
  });
}

function enterGameScreen() {
  getEl("login").classList.add("hidden");
  getEl("game").classList.remove("hidden");
  getEl("roomTitle").innerText = roomCode;

  // Main Listener
  db.ref("rooms/"+roomCode).on("value", snapshot => {
    dbData = snapshot.val();
    if(!dbData) { alert("Room closed"); location.reload(); return; }

    const players = Object.keys(dbData.scores || {});
    const playerCount = players.length;

    // --- AUTO START LOGIC ---
    // If waiting and we now have 2 players, host triggers "playing"
    if (isHost && dbData.state === "waiting" && playerCount === 2) {
        db.ref("rooms/"+roomCode).update({ state: "playing" });
    }

    // --- UI SWITCHING ---
    if (dbData.state === "waiting") {
        getEl("lobby").classList.remove("hidden");
        getEl("gameArea").classList.add("hidden");
    } else {
        getEl("lobby").classList.add("hidden");
        getEl("gameArea").classList.remove("hidden");
    }

    // --- GAME END HANDLING ---
    if(dbData.state === "ended") {
       getEl("gameOverMsg").classList.remove("hidden");
       if(isHost) getEl("hostControls").classList.remove("hidden");
    } else {
       getEl("gameOverMsg").classList.add("hidden");
       getEl("hostControls").classList.add("hidden");
    }

    // Render Game Elements
    if(dbData.state !== "waiting") {
        renderGrid(dbData.cards, dbData.open || []);
        getEl("time").innerText = dbData.time;
    }
    
    renderScores(dbData.scores || {});
    renderChat(dbData.chat || {});
  });

  // Timer Logic (Runs only when state is playing)
  if(isHost) {
    setInterval(() => {
      // We check dbData directly since the listener updates it
      if(dbData && dbData.state === "playing" && dbData.time > 0) {
          db.ref("rooms/"+roomCode+"/time").set(dbData.time - 1);
      } else if (dbData && dbData.time <= 0 && dbData.state === "playing") {
          db.ref("rooms/"+roomCode+"/state").set("ended");
      }
    }, 1000);
  }
}

// --- RENDER FUNCTIONS ---
function renderGrid(cards, openIndexes) {
  const grid = getEl("grid");
  grid.innerHTML = "";
  cards.forEach((icon, index) => {
    const card = document.createElement("div");
    card.className = "card";
    
    const isMatched = openIndexes.includes(index);
    const isLocalFlip = (firstCard && firstCard.index === index);

    if (isMatched || isLocalFlip) {
      card.innerText = icon;
      card.classList.add("open");
    } else {
      card.innerText = "";
    }
    card.onclick = () => handleCardClick(index, icon, openIndexes);
    grid.appendChild(card);
  });
}

function renderScores(scores) {
  const el = getEl("scores");
  let html = "";
  Object.entries(scores).forEach(([name, score]) => {
    // Highlight current user
    const style = name === user ? "color:#4ade80; font-weight:bold" : "";
    html += `<span style="${style}">${name}: ${score} pts</span>`;
  });
  el.innerHTML = html;
}

function renderChat(chatData) {
  const chatBox = getEl("chat");
  chatBox.innerHTML = "";
  Object.values(chatData).forEach(msg => {
    const div = document.createElement("div");
    div.className = "chat-msg";
    div.innerText = msg;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

// --- INTERACTION ---
function handleCardClick(index, icon, openIndexes) {
  if (dbData.state !== "playing" || isLocked || openIndexes.includes(index)) return;
  if (firstCard && firstCard.index === index) return;

  if (!firstCard) {
    firstCard = { index, icon };
    renderGrid(dbData.cards, openIndexes);
  } else {
    renderGrid(dbData.cards, openIndexes);
    if (firstCard.icon === icon) {
      const newOpen = [...openIndexes, firstCard.index, index];
      db.ref("rooms/"+roomCode+"/open").set(newOpen);
      db.ref("rooms/"+roomCode+"/scores/"+user).transaction(s => (s||0) + 1);
      firstCard = null;
    } else {
      const cards = document.getElementsByClassName("card");
      cards[index].innerText = icon; 
      cards[index].classList.add("open");
      isLocked = true;
      setTimeout(() => {
        cards[index].innerText = ""; cards[index].classList.remove("open");
        firstCard = null; isLocked = false;
        renderGrid(dbData.cards, openIndexes);
      }, 800);
    }
  }
}

function sendChat(e) {
  if(e.key !== "Enter" || !e.target.value.trim()) return;
  db.ref("rooms/"+roomCode+"/chat").push(`${user}: ${e.target.value}`);
  e.target.value = "";
}

function restartGame() {
  if(!isHost) return;
  db.ref("rooms/"+roomCode).update({
    cards: shuffle([...icons, ...icons]),
    open: [],
    // Reset scores to 0 but keep players
    scores: Object.fromEntries(Object.keys(dbData.scores).map(k=>[k,0])), 
    time: 120,
    state: "playing", // Restart sets it immediately to playing
    chat: {}
  });
  firstCard = null; isLocked = false;
}

function closeRoom() {
  if(confirm("Close room?")) {
    db.ref("rooms/"+roomCode).remove();
    location.reload();
  }
}
function copyCode() {
    navigator.clipboard.writeText(roomCode);
    alert("Room name copied!");
}
</script>

</body>
</html>

